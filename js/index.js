$(function(){function t(){clearTimeout(f),f=setTimeout(function(){if(!s){n.addClass("show"),s=!0;var t=r.getBounds().getNorthEast(),e=r.getBounds().getSouthWest();$.ajax({url:"get_markers.php",data:{NorthEast:{latitude:t.lat(),longitude:t.lng()},SouthWest:{latitude:e.lat(),longitude:e.lng()}},async:!0,cache:!1,dataType:"json",type:"POST",beforeSend:function(){}}).done(function(t){if(t.status){var e=t.markers.map(function(t){var e=new MarkerWithLabel({position:new google.maps.LatLng(t.lat,t.lng),draggable:!1,raiseOnDrag:!1,clickable:!0,labelContent:'<img src="'+t.url+'" />',labelAnchor:new google.maps.Point(50,50),labelClass:"marker_label",icon:{path:"M 0 0"}});return google.maps.event.addListener(e,"click",function(){$fancyBox.attr("title",t.des).attr("href",t.url.ori).click()}),{id:t.id,marker:e}}),o=a.diff(e),i=e.diff(a),r=o.map(function(t){return t.id}),f=i.map(function(t){return t.id});l.removeMarkers(o.map(function(t){return t.marker})),l.addMarkers(i.map(function(t){return t.marker})),a=a.filter(function(t){return-1==$.inArray(t.id,r)}).concat(e.filter(function(t){return-1!=$.inArray(t.id,f)})),n.removeClass("show"),s=!1}}).fail(function(t){ajaxError(t)}).complete(function(){})}},500)}function e(){var e=new google.maps.StyledMapType([{featureType:"transit.station.bus",stylers:[{visibility:"off"}]},{featureType:"poi",stylers:[{visibility:"off"}]},{featureType:"poi.attraction",stylers:[{visibility:"on"}]},{featureType:"poi.school",stylers:[{visibility:"on"}]}]),n={zoom:14,scaleControl:!0,navigationControl:!0,disableDoubleClickZoom:!0,mapTypeControl:!1,zoomControl:!0,scrollwheel:!0,streetViewControl:!1,center:new google.maps.LatLng(25.022073145389157,121.54706954956055)};r=new google.maps.Map(o.get(0),n),r.mapTypes.set("map_style",e),r.setMapTypeId("map_style"),l=new MarkerClusterer(r,[],{styles:[{url:"img/map/set/1.png",height:74,width:75,textSize:20,textColor:"#ffffff",backgroundPosition:"0 -4px"},{url:"img/map/set/2.png",height:74,width:75,textSize:20,textColor:"#ffffff",backgroundPosition:"0 -4px"},{url:"img/map/set/3.png",height:74,width:75,textSize:20,textColor:"#ffffff",backgroundPosition:"0 -4px"},{url:"img/map/set/4.png",height:74,width:75,textSize:20,textColor:"#ffffff",backgroundPosition:"0 -4px"},{url:"img/map/set/5.png",height:74,width:75,textSize:20,textColor:"#ffffff",backgroundPosition:"0 -4px"}]}),google.maps.event.addListener(r,"zoom_changed",t),google.maps.event.addListener(r,"dragend",t),i.fadeOut(function(){$(this).hide(function(){$(this).remove(),t()})})}var o=$("#map"),n=$(".map .loading_data"),i=$("<div />").attr("id","loading").append($("<div />")).appendTo($(".map")),r=null,a=[],l=null,s=!1,f=null;window.ajaxError=function(t){console.error(t.responseText)},Array.prototype.diff=function(t){return this.filter(function(e){return t.map(function(t){return t.id}).indexOf(e.id)<0})},google.maps.event.addDomListener(window,"load",e)});